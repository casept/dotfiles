#!/usr/bin/env python3
"""
Get off the PC is a small script that nags the user if he's logged in after 22:30 local time.
I made this to curb my reddit addiction.
"""

from datetime import datetime, timedelta, date
import time
import subprocess
import argparse
import notify2


def main():
    print("Starting...")
    args = parse_args()
    while True:
        # Wait until 22:30
        timer(args.alert_on_weekend, args.minute, args.hour)
        # Nag the user
        nag(args.hour, args.minute, args.delay)
        print("Shutdown in", args.delay, "seconds")
        time.sleep(args.delay)
        # Shut down the machine
        print("Shutdown")
        subprocess.check_call(args=["systemctl", "poweroff"])


def parse_args():
    parser = argparse.ArgumentParser(
        description="Shut off the PC at a specified time so you don't lose sleep.")
    parser.add_argument(
        "--weekend", help="whether to alert on weekends", default=False, dest="alert_on_weekend", action="store_true")
    parser.add_argument(
        "--minute", type=int, help="The minute (local time) when to run the script", default=0, dest="minute")
    parser.add_argument(
        "--hour", type=int, help="The hour (local time, 24 hour format) when to run the script", default=0, dest="hour")
    parser.add_argument(
        "--delay", type=int, help="How many seconds to wait after showing notification before shutdown", default=300, dest="delay")
    args = parser.parse_args()
    return args


def timer(alert_on_weekend, minute, hour):
    seconds_till_time = (timedelta(hours=24) - (datetime.now() - datetime.now().replace(hour=hour, minute=minute, second=0, microsecond=0))
                         ).total_seconds() % (24 * 3600)

    print("Time until ", hour, ":", minute, ": ", seconds_till_time, "seconds")
    while True:
        if seconds_till_time > 60:
            # Sleep for a minute
            time.sleep(60)
        else:
            if alert_on_weekend:
                # Check if it's a weekend, don't alert if it is
                if datetime.isoweekday(date.today()) == 5 or datetime.isoweekday(date.today()) == 6:
                    print("Weekend, not alerting")
                    # Wait until alerting window is over
                    time.sleep(60)
                else:
                    return
            else:
                return


def nag(hour, minute, delay):
    notify2.init("Get off the PC!")
    n = notify2.Notification(summary="Automatic shutdown",
                             message="It's %d:%d already! Shutting down in %d seconds." % (hour, minute, delay))
    n.set_urgency(notify2.URGENCY_CRITICAL)
    # Show for 20s
    n.set_timeout(20000)
    n.show()

if __name__ == "__main__":
    main()
